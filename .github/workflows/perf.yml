name: rafka-perf

on:
  workflow_dispatch:
  schedule:
    - cron: "0 4 * * 1"

concurrency:
  group: rafka-perf-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: read

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: "1"

jobs:
  perf-baseline:
    name: Performance baseline
    runs-on: ubuntu-latest
    timeout-minutes: 90

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Resolve project paths
        id: paths
        run: |
          if [[ -d "rafka" ]]; then
            echo "workdir=rafka" >> "${GITHUB_OUTPUT}"
            echo "artifact_prefix=rafka/" >> "${GITHUB_OUTPUT}"
          else
            echo "workdir=." >> "${GITHUB_OUTPUT}"
            echo "artifact_prefix=" >> "${GITHUB_OUTPUT}"
          fi

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust build
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: ${{ steps.paths.outputs.workdir }} -> target

      - name: Run perf harness
        working-directory: ${{ steps.paths.outputs.workdir }}
        run: |
          mkdir -p perf-artifacts
          ./scripts/run_perf_harness.sh \
            --mode both \
            --duration-secs 10 \
            --target-rates 1000,10000,100000,1000000 \
            --payload-bytes 1024 | tee perf-artifacts/perf.csv

      - name: Publish job summary
        working-directory: ${{ steps.paths.outputs.workdir }}
        run: |
          {
            echo "### Rafka perf baseline"
            echo
            echo '```csv'
            cat perf-artifacts/perf.csv
            echo '```'
          } >> "${GITHUB_STEP_SUMMARY}"

      - name: Upload perf artifacts
        uses: actions/upload-artifact@v4
        with:
          name: rafka-perf-results
          path: ${{ steps.paths.outputs.artifact_prefix }}perf-artifacts/
          retention-days: 14
